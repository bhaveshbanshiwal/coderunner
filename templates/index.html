<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeSphere - Online Python & C++ IDE</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Ace Editor for the code editor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>

    <style>
        /* Custom scrollbar for a better look */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        /* Style for the Ace editor */
        #editor {
            width: 100%;
            height: 100%;
            font-size: 16px;
        }
        .tab-button.active {
            background-color: #1e293b; /* bg-slate-800 */
            border-bottom: 2px solid #6366f1; /* indigo-500 */
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-300 font-sans">

    <div id="app" class="flex flex-col h-screen">

        <!-- ======================= -->
        <!-- HEADER NAVIGATION BAR   -->
        <!-- ======================= -->
        <header class="bg-slate-800 border-b border-slate-700 p-2 flex justify-between items-center">
            <!-- Logo and Title -->
            <div class="flex items-center">
                <i class="fas fa-code text-indigo-400 text-2xl mr-2"></i>
                <h1 class="text-xl font-bold text-slate-100">CodeSphere</h1>
            </div>
            <div class="flex items-center space-x-4">
                <!-- Language switcher dropdown -->
                <div class="relative">
                    <select id="language-switcher" class="bg-slate-700 text-white font-bold py-2 px-4 rounded-lg appearance-none focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="python">Python</option>
                        <option value="cpp">C++</option>
                    </select>
                </div>
                <!-- RUN BUTTON: Executes the code in the editor -->
                <button id="run-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg flex items-center transition-colors">
                    <i class="fas fa-play mr-2"></i>
                    <span>Run</span>
                </button>
                 <!-- CLEAR BUTTON: Clears the terminal output -->
                 <button id="clear-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg flex items-center transition-colors">
                    <i class="fas fa-trash mr-2"></i>
                    <span>Clear</span>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow flex overflow-hidden">

            <!-- ======================= -->
            <!-- FILE EXPLORER           -->
            <!-- ======================= -->
            <aside class="w-1/5 bg-slate-800 p-4 overflow-y-auto border-r border-slate-700">
                <h2 class="text-lg font-semibold mb-4 text-slate-100">File Explorer</h2>
                <!-- The file list is dynamically generated by JavaScript -->
                <ul id="file-explorer" class="space-y-2">
                    <!-- File items will be injected by JavaScript -->
                </ul>
            </aside>

            <!-- Code Editor and Terminal -->
            <div class="w-4/5 flex flex-col">
                
                <!-- ACE CODE EDITOR: The main text area for writing code -->
                <div class="flex-grow h-2/3">
                    <div id="editor"></div>
                </div>

                <!-- Resizer Handle -->
                <div class="w-full h-2 bg-slate-700 cursor-row-resize"></div>

                <!-- ======================= -->
                <!-- TERMINAL & PACKAGES TABS -->
                <!-- ======================= -->
                <div class="h-1/3 flex flex-col bg-slate-900">
                    <!-- Tab Navigation Buttons -->
                    <div class="flex border-b border-slate-700">
                        <button class="tab-button active p-3" data-tab="terminal">Terminal</button>
                        <button id="packages-tab-button" class="tab-button p-3" data-tab="packages">Packages</button>
                    </div>
                    <!-- TERMINAL TAB: Shows the output of the executed code -->
                    <div id="terminal-tab" class="tab-content flex-grow p-4 overflow-y-auto">
                        <pre id="output"></pre>
                    </div>
                    <!-- PACKAGES TAB: Allows installing Python packages -->
                    <div id="packages-tab" class="tab-content hidden flex-grow p-4 overflow-y-auto">
                        <div class="flex mb-4">
                            <input type="text" id="package-input" class="flex-grow bg-slate-800 border border-slate-600 rounded-l-lg p-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="e.g., numpy, pandas">
                            <button id="install-package-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-r-lg">Install</button>
                        </div>
                        <h3 class="font-semibold mb-2">Installed Packages:</h3>
                        <ul id="installed-packages" class="list-disc list-inside">
                            <li>python 3.10</li>
                            <li>pip 22.0.4</li>
                        </ul>
                    </div>
                </div>
            </div>
        </main>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Ace Editor Setup ---
            const editor = ace.edit("editor");
            editor.setTheme("ace/theme/monokai");
            
            // Set initial editor mode to Python
            editor.session.setMode("ace/mode/python");
            editor.setValue(`# Welcome to CodeSphere!
# Your online Python IDE.

def greet(name):
    print(f"Hello, {name}!")

greet("World")
`);

            // --- File Explorer (Visual Only) ---
            const fileExplorer = document.getElementById('file-explorer');
            const files = [
                { name: 'main.py', icon: 'fab fa-python' },
                { name: 'main.cpp', icon: 'fas fa-file-code' },
                { name: 'utils', icon: 'fas fa-folder', children: [
                    { name: 'helpers.py', icon: 'fab fa-python' }
                ]},
                { name: 'README.md', icon: 'fas fa-file-alt' },
            ];

            function renderFileExplorer(items, container) {
                items.forEach(item => {
                    const li = document.createElement('li');
                    let content;
                    if (item.children) {
                        content = `
                            <div class="cursor-pointer flex items-center">
                                <i class="${item.icon} mr-2 text-yellow-400"></i>
                                <span>${item.name}</span>
                            </div>
                            <ul class="ml-4 hidden space-y-1 mt-1"></ul>
                        `;
                        li.innerHTML = content;
                        const sublist = li.querySelector('ul');
                        renderFileExplorer(item.children, sublist);
                        li.querySelector('div').addEventListener('click', () => {
                            sublist.classList.toggle('hidden');
                        });
                    } else {
                        content = `
                            <div class="cursor-pointer flex items-center hover:bg-slate-700 p-1 rounded">
                                <i class="${item.icon} mr-2 text-blue-400"></i>
                                <span>${item.name}</span>
                            </div>
                        `;
                         li.innerHTML = content;
                    }
                    container.appendChild(li);
                });
            }
            renderFileExplorer(files, fileExplorer);
            
            // --- Backend Connection Logic ---
            const outputEl = document.getElementById('output');
            const runButton = document.getElementById('run-button');
            const clearButton = document.getElementById('clear-button');
            const packageInput = document.getElementById('package-input');
            const installPackageButton = document.getElementById('install-package-button');
            const installedPackagesList = document.getElementById('installed-packages');
            const languageSwitcher = document.getElementById('language-switcher');
            const packagesTabButton = document.getElementById('packages-tab-button');
            const packagesTab = document.getElementById('packages-tab');
            const terminalTabButton = document.querySelector('button[data-tab="terminal"]');

            // C++ hello world code
            const cppDefaultCode = `#include <iostream>

int main() {
    std::cout << "Hello, C++ World!" << std::endl;
    return 0;
}`;

            // Event listener for the language switcher
            languageSwitcher.addEventListener('change', (event) => {
                const language = event.target.value;
                if (language === 'python') {
                    editor.session.setMode("ace/mode/python");
                    editor.setValue(document.getElementById('editor')._pythonCode || `# Python code`);
                    packagesTabButton.style.display = 'inline-block'; // Show packages tab
                } else if (language === 'cpp') {
                    editor.session.setMode("ace/mode/c_cpp");
                    editor.setValue(cppDefaultCode);
                    packagesTabButton.style.display = 'none'; // Hide packages tab
                    // If packages tab was active, switch to terminal
                    if(packagesTab.classList.contains('active')) {
                        packagesTab.classList.add('hidden');
                        terminalTabButton.click();
                    }
                }
            });

            // RUN BUTTON: Event Listener
            runButton.addEventListener('click', async () => {
                const code = editor.getValue();
                // Check the selected language and call the appropriate API endpoint
                const selectedLanguage = languageSwitcher.value;
                let endpoint = '';
                let prompt = '';

                if (selectedLanguage === 'python') {
                    endpoint = '/api/run';
                    prompt = '$ python main.py';
                } else if (selectedLanguage === 'cpp') {
                    endpoint = '/api/run_cpp';
                    prompt = '$ g++ main.cpp -o main && ./main';
                }
                
                outputEl.innerHTML += `<span class="text-green-400">${prompt}</span>\n`;
                
                try {
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ code: code })
                    });
                    const result = await response.json();
                    
                    const outputNode = document.createTextNode(`${result.output}\n\n`);
                    outputEl.appendChild(outputNode);

                } catch (error) {
                    outputEl.innerHTML += `<span class="text-red-400">Error connecting to backend: ${error}</span>\n\n`;
                }
                outputEl.scrollTop = outputEl.scrollHeight;
            });

            // CLEAR BUTTON: Event Listener
            clearButton.addEventListener('click', () => {
                outputEl.innerHTML = '';
            });

            // INSTALL PACKAGE BUTTON: Event Listener
            installPackageButton.addEventListener('click', async () => {
                const packageName = packageInput.value.trim();
                if (packageName) {
                    outputEl.innerHTML += `<span class="text-yellow-400">Installing ${packageName}...</span>\n`;
                    
                     try {
                        const response = await fetch('/api/install', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ package: packageName })
                        });
                        const result = await response.json();

                        const logNode = document.createTextNode(`${result.log}\n\n`);
                        outputEl.appendChild(logNode);

                        if(result.success) {
                            const newPackage = document.createElement('li');
                            newPackage.textContent = packageName;
                            installedPackagesList.appendChild(newPackage);
                            packageInput.value = '';
                        }

                    } catch (error) {
                        outputEl.innerHTML += `<span class="text-red-400">Error connecting to backend: ${error}</span>\n\n`;
                    }
                    outputEl.scrollTop = outputEl.scrollHeight;
                }
            });

            // --- TABS ---
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    const tab = button.dataset.tab;
                    tabContents.forEach(content => {
                        if (content.id === `${tab}-tab`) {
                            content.classList.remove('hidden');
                        } else {
                            content.classList.add('hidden');
                        }
                    });
                });
            });
        });
    </script>

</body>
</html>
